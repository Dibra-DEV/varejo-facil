trigger:
  branches:
    include:
      - main

pool:
  name: vm-windows

steps:

- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: '1. Instalar Node.js'

- script: npm install --force
  displayName: '2. Instalar Dependências'
  
- script: npm run build
  displayName: '3. Executar Build do Projeto'

- task: CopyFiles@2
  displayName: '4. Copiar Arquivos de Build'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)\dist'
    Contents: '**'
    TargetFolder: 'C:\app\varejo-facil'
    CleanTargetFolder: true
    OverWrite: true

- script: |
    npm install -g pm2
    npx pm2 delete varejo-facil || echo "Aplicação não encontrada."
    npx pm2 serve "C:\app\varejo-facil" 3000 --name varejo-facil --spa
    npx pm2 save --force
  displayName: '5. Instalar PM2 e Rodar App'

- script: npx pm2 list
  displayName: '6. Verificar Status do PM2'
  continueOnError: "true"