trigger:
  branches:
    include:
      - main

pool:
  name: vm-windows

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: '1. Instalar Node.js (20.x)'

- script: |
    echo "ğŸ“¦ Instalando dependÃªncias..."
    npm install --force

    echo "ğŸ—ï¸ Iniciando build..."
    npm run build

    echo "ğŸ§© Verificando se a pasta 'dist' foi criada na raiz do projeto:"
    dir dist

    echo "ğŸ” Se a listagem acima estiver vazia ou der erro, o build falhou."
    if not exist dist (
      echo "##[error]ERRO CRÃTICO: A pasta 'dist' nÃ£o foi criada pelo comando 'npm run build'."
      exit 1
    )
  displayName: '2. Build do Projeto e VerificaÃ§Ã£o'

- powershell: |
    Write-Host "ğŸšš Iniciando cÃ³pia da pasta 'dist' para C:\deploy\varejo-facil..."

    # Mostrar estrutura atual (Ãºtil pra debug)
    Write-Host "ğŸ“ Estrutura de diretÃ³rios onde o build rodou:"
    Get-ChildItem "$(Build.SourcesDirectory)" -Recurse -Directory | Where-Object { $_.Name -eq "dist" }

    # Limpar o diretÃ³rio de destino, se existir
    if (Test-Path "C:\deploy\varejo-facil") {
      Write-Host "ğŸ§¹ Limpando diretÃ³rio antigo em C:\deploy\varejo-facil..."
      Remove-Item -Recurse -Force "C:\deploy\varejo-facil"
    }

    # Criar o novo diretÃ³rio de destino
    Write-Host "ğŸ“‚ Criando diretÃ³rio de destino..."
    New-Item -ItemType Directory -Force -Path "C:\deploy\varejo-facil" | Out-Null

    # Copiar o conteÃºdo do build
    Write-Host "ğŸ“¤ Copiando arquivos do build..."
    Copy-Item "$(Build.SourcesDirectory)\dist\*" "C:\deploy\varejo-facil" -Recurse -Force -ErrorAction Stop

    Write-Host "âœ… Build copiado com sucesso para C:\deploy\varejo-facil"
  displayName: '3. Copiar Build Corrigido para VM (PowerShell)'

- script: |
    echo "âš™ï¸ Instalando PM2 e iniciando aplicaÃ§Ã£o..."
    npm install -g pm2
    npx pm2 delete varejo-facil || echo "AplicaÃ§Ã£o nÃ£o encontrada."
    npx pm2 serve "C:\deploy\varejo-facil" 3000 --name varejo-facil --spa
    npx pm2 save --force
  displayName: '4. Instalar PM2 e Rodar App'

- script: |
    echo "ğŸ§­ Verificando status dos processos PM2..."
    npx pm2 list
  displayName: '5. Verificar Status do PM2'
  continueOnError: "true"
