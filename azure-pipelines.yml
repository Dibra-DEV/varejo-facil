trigger:
  branches:
    include:
      - main

pool:
  name: vm-windows

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: '1. Instalar Node.js (20.x)'

  - script: |
      echo "Instalando dependências..."
      npm install --force
      
      echo "Iniciando Build..."
      npm run build
      
      echo "Verificando os arquivos e pastas criados na raiz do projeto:"
      dir
      
      echo "Instalando PM2 globalmente..."
      npm install -g pm2
    displayName: '2. Build do projeto e Instalar PM2'

  - script: |
      echo "Copiando build para pasta de deploy (C:\deploy\varejo-facil)"
      
      REM =====================================================================
      REM IMPORTANTE: Verifique o log do passo 2. Se a pasta de build não for 'dist',
      REM substitua 'dist' no comando abaixo pelo nome correto da pasta.
      REM Exemplo: robocopy "$(Build.SourcesDirectory)\build" ...
      REM =====================================================================
      robocopy "$(Build.SourcesDirectory)\dist" "C:\deploy\varejo-facil" /E /PURGE
    displayName: '3. Copiar build para VM (com Robocopy)'

  - script: |
      echo "Reiniciando app com PM2"
      npx pm2 delete varejo-facil || echo "Aplicação não encontrada, iniciando pela primeira vez."
      echo "Iniciando o servidor para a SPA..."
      npx pm2 serve C:\deploy\varejo-facil 3000 --name varejo-facil --spa
      echo "Salvando a lista de processos do PM2..."
      npx pm2 save --force
    displayName: '4. Rodar app com PM2'

  - script: |
      echo "Verificando status dos processos PM2:"
      npx pm2 list
    displayName: '5. VERIFICAR STATUS DO PM2'
    continueOnError: "true"